<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Data</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; }
        label, input { display: block; margin: 10px 0; }
        #weatherData { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Weather Data Request</h1>
    
    <form id="weatherForm">
        <label for="location">Location (City or Address):</label>
        <input type="text" id="location" name="location" placeholder="Enter city or address">

        <label for="latitude">Latitude:</label>
        <input type="text" id="latitude" name="latitude" required>

        <label for="longitude">Longitude:</label>
        <input type="text" id="longitude" name="longitude" required>

        <label for="start_date">Start Date (YYYY-MM-DD):</label>
        <input type="date" id="start_date" name="start_date" required>

        <label for="end_date">End Date (YYYY-MM-DD):</label>
        <input type="date" id="end_date" name="end_date" required>

        <button type="button" onclick="fetchWeatherData()">Get Weather Data</button>
    </form>

    <div id="weatherData"></div>
    
    <div></div>
        <button type="button" onclick="window.location.href='user_preferences.html'">change user preferences</button>
    <div></div>

    <!-- Logout Button -->
    <button id="logout-button">Logout</button>


    <script>
        async function getCoordinates(location) {
            const geocodeUrl = `https://api.opencagedata.com/geocode/v1/json?q=${location}&key=3935ede2f1d745c896731b673f7fc90b`;

            try {
                const response = await fetch(geocodeUrl);
                const data = await response.json();

                if (data.results.length > 0) {
                    const { lat, lng } = data.results[0].geometry;
                    return { latitude: lat, longitude: lng };
                } else {
                    throw new Error("Location not found.");
                }
            } catch (error) {
                document.getElementById("weatherData").innerText = `Geocoding Error: ${error.message}`;
            }
        }

        async function fetchWeatherData() {
            const location = document.getElementById("location").value;
            let latitude, longitude;

            if (location) {
                const coords = await getCoordinates(location);
                if (coords) {
                    latitude = coords.latitude;
                    longitude = coords.longitude;
                } else {
                    return; // Exit if location not found
                }
            } else {
                latitude = document.getElementById("latitude").value;
                longitude = document.getElementById("longitude").value;
            }

            const startDate = document.getElementById("start_date").value;
            const endDate = document.getElementById("end_date").value;

            const url = `http://127.0.0.1:5000/weather?latitude=${latitude}&longitude=${longitude}&start_date=${startDate}&end_date=${endDate}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                if (response.ok) {
                    displayWeatherData(data);
                } else {
                    document.getElementById("weatherData").innerText = `Error: ${data.error}`;
                }
            } catch (error) {
                document.getElementById("weatherData").innerText = `Error: ${error.message}`;
            }
        }


        function displayWeatherData(data) {
            const container = document.getElementById("weatherData");
            container.innerHTML = "<h2>Weather Data:</h2>";

            data.forEach(record => {
                container.innerHTML += `
                    <p>
                        Date & Time: ${record.datetime} <br>
                        Temperature: ${record.temperature} Â°C <br>
                        Humidity: ${record.humidity} %
                    </p>
                    <hr>
                `;
            });
        }

        document.getElementById('logout-button').addEventListener('click', () => {
            localStorage.removeItem('user_id');
            window.location.href = 'login.html';
        });
    </script>
</body>
</html>
