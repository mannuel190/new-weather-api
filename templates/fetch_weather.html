<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Data</title>

    <!-- Import Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
    <script>
        // Check if the user is logged in by verifying localStorage for user_id
        const userId = localStorage.getItem('user_id');
        if (!userId) 
        {
            alert("You are not logged in. Redirecting to login page...");
            window.location.href = "/"; // Redirect to login page
        }
    </script>
    <div class="max-w-4xl mx-auto p-6 bg-white shadow-lg rounded-lg">
        <h1 class="text-2xl font-bold text-gray-800 mb-4">Weather Data Request</h1>

        <!-- Form for weather data input -->
        <form id="weatherForm" class="space-y-4">
            <!-- Input field for location -->
            <div>
                <label for="location" class="block text-sm font-medium text-gray-700">
                    Location (City or Address):
                </label>
                <input 
                    type="text" 
                    id="location" 
                    name="location" 
                    placeholder="Enter city or address"
                    class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                >
            </div>

            <!-- Hidden fields for latitude and longitude -->
            <input type="text" id="latitude" name="latitude" hidden>
            <input type="text" id="longitude" name="longitude" hidden>

            <!-- Input fields for start and end dates -->
            <div>
                <label for="start_date" class="block text-sm font-medium text-gray-700">
                    Start Date (YYYY-MM-DD):
                </label>
                <input 
                    type="date" 
                    id="start_date" 
                    name="start_date"
                    class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" 
                    required
                >
            </div>
            <div>
                <label for="end_date" class="block text-sm font-medium text-gray-700">
                    End Date (YYYY-MM-DD):
                </label>
                <input 
                    type="date" 
                    id="end_date" 
                    name="end_date"
                    class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" 
                    required
                >
            </div>

            <!-- Buttons for fetching data and using geolocation -->
            <div class="flex space-x-4">
                <button 
                    type="button" 
                    onclick="fetchWeatherData()"
                    class="px-4 py-2 bg-blue-600 text-white rounded-md shadow hover:bg-blue-700"
                >
                    Get Weather Data
                </button>
                <button 
                    type="button" 
                    onclick="useMyLocation()"
                    class="px-4 py-2 bg-green-600 text-white rounded-md shadow hover:bg-green-700"
                >
                    Use My Location
                </button>
            </div>
        </form>

        <!-- Section for displaying weather data -->
        <div id="weatherData" class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-300 shadow-md"></div>

        <!-- Section for map display -->
        <div id="map" class="mt-6 rounded-lg shadow-md" style="height: 400px;"></div>

        <br>
        <br>
        
        <!-- User preferences and logout buttons -->
        <div class="flex justify-between mt-6">
            <button 
                type="button" 
                onclick="window.location.href='/preferences'"
                class="px-4 py-2 bg-yellow-600 text-white rounded-md shadow hover:bg-yellow-700"
            >
                Change User Preferences
            </button>
            <button 
                id="logout-button"
                class="px-4 py-2 bg-red-600 text-white rounded-md shadow hover:bg-red-700"
            >
                Logout
            </button>
        </div>
    </div>

    <!-- Import Mapbox JS -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    
        // Supabase configuration
        const supabaseUrl = 'https://ewuamuzcbsrkmpjkrdmn.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3dWFtdXpjYnNya21wamtyZG1uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzAxNDE0MDIsImV4cCI6MjA0NTcxNzQwMn0.SPo5KG3ufHN0dt4Jxvl-sAJ9tZanRA9G1JxGHFrLOBc';
        const supabase = createClient(supabaseUrl, supabaseKey);
    
        let isEditing = false;
    
        /**
         * Function to fetch coordinates for a given location
         * @param {string} location - The location name
         * @returns {Promise<Object>} - The latitude and longitude of the location
         */
        async function getCoordinates(location) {
            const geocodeUrl = `https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(location)}&key=3935ede2f1d745c896731b673f7fc90b`;
            try {
                const response = await fetch(geocodeUrl);
                const data = await response.json();
    
                if (data.results.length > 0) {
                    const { lat, lng } = data.results[0].geometry;
                    return { latitude: lat, longitude: lng };
                } else {
                    throw new Error("Location not found.");
                }
            } catch (error) {
                alert(`Geocoding Error: ${error.message}`);
                return null;
            }
        }
    
        /**
         * Function to delete a preference
         * @param {string} pref_id - The ID of the preference to delete
         */
        async function deletePreference(pref_id) {
            if (!confirm('Are you sure you want to delete this preference?')) {
                return;
            }
    
            try {
                const { error } = await supabase
                    .from('user_preferences')
                    .update({ deleted: true }) // Soft delete by marking as deleted
                    .eq('pref_id', pref_id);
    
                if (error) {
                    alert(`Error deleting preference: ${error.message}`);
                } else {
                    alert('Preference deleted successfully!');
                    loadPreferences(); // Reload preferences after deletion
                }
            } catch (err) {
                alert(`Unexpected error deleting preference: ${err.message}`);
            }
        }
    
        /**
         * Function to edit an existing preference
         * @param {Object} preference - The preference object to edit
         */
        function editPreference(preference) {
            document.getElementById('pref_id').value = preference.pref_id;
            document.getElementById('location').value = preference.location;
            document.getElementById('latitude').value = preference.latitude;
            document.getElementById('longitude').value = preference.longitude;
            document.getElementById('temp_min').value = preference.temp_min;
            document.getElementById('temp_max').value = preference.temp_max;
            document.getElementById('humidity_min').value = preference.humidity_min;
            document.getElementById('humidity_max').value = preference.humidity_max;
    
            isEditing = true;
            document.getElementById('save-button').textContent = "Update Preferences";
        }
    
        /**
         * Function to load preferences from the database
         */
        async function loadPreferences() {
            const user_id = localStorage.getItem('user_id');
    
            try {
                const { data, error } = await supabase
                    .from('user_preferences')
                    .select('*')
                    .eq('user_id', user_id)
                    .eq('deleted', false);
    
                if (error) {
                    alert(`Error loading preferences: ${error.message}`);
                    return;
                }
    
                const table = document.getElementById('preferences-table');
                table.innerHTML = ''; // Clear existing rows
    
                data.forEach(preference => {
                    const row = table.insertRow();
                    row.insertCell(0).textContent = preference.location;
                    row.insertCell(1).textContent = preference.latitude;
                    row.insertCell(2).textContent = preference.longitude;
                    row.insertCell(3).textContent = preference.temp_min;
                    row.insertCell(4).textContent = preference.temp_max;
                    row.insertCell(5).textContent = preference.humidity_min;
                    row.insertCell(6).textContent = preference.humidity_max;
    
                    const actionsCell = row.insertCell(7);
    
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit';
                    editButton.className = 'edit-button';
                    editButton.onclick = () => editPreference(preference);
                    actionsCell.appendChild(editButton);
    
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.className = 'delete-button';
                    deleteButton.onclick = () => deletePreference(preference.pref_id);
                    actionsCell.appendChild(deleteButton);
                });
            } catch (err) {
                alert(`Unexpected error loading preferences: ${err.message}`);
            }
        }
    
        /**
         * Form submission handler to save or update preferences
         */
        document.getElementById('preferences-form').addEventListener('submit', async (event) => {
            event.preventDefault();
    
            const user_id = localStorage.getItem('user_id');
            if (!user_id) {
                alert('You are not logged in.');
                return;
            }
    
            // Collect form data
            const pref_id = document.getElementById('pref_id').value;
            const location = document.getElementById('location').value;
            const temp_min = parseFloat(document.getElementById('temp_min').value);
            const temp_max = parseFloat(document.getElementById('temp_max').value);
            const humidity_min = parseFloat(document.getElementById('humidity_min').value);
            const humidity_max = parseFloat(document.getElementById('humidity_max').value);
    
            // Fetch latitude and longitude if not already present
            let latitude = parseFloat(document.getElementById('latitude').value);
            let longitude = parseFloat(document.getElementById('longitude').value);
    
            if (!latitude || !longitude) {
                const coordinates = await getCoordinates(location);
                if (coordinates) {
                    latitude = coordinates.latitude;
                    longitude = coordinates.longitude;
                } else {
                    alert('Unable to fetch coordinates for the provided location.');
                    return;
                }
            }
    
            try {
                if (isEditing) {
                    // Update existing preference
                    const { error } = await supabase
                        .from('user_preferences')
                        .update({
                            location,
                            latitude,
                            longitude,
                            temp_min,
                            temp_max,
                            humidity_min,
                            humidity_max,
                        })
                        .eq('pref_id', pref_id)
                        .eq('user_id', user_id);
    
                    if (error) {
                        alert(`Error updating preference: ${error.message}`);
                        return;
                    }
                    alert('Preference updated successfully!');
                } else {
                    // Add new preference
                    const { error } = await supabase
                        .from('user_preferences')
                        .insert([{
                            user_id,
                            location,
                            latitude,
                            longitude,
                            temp_min,
                            temp_max,
                            humidity_min,
                            humidity_max,
                            deleted: false,
                        }]);
    
                    if (error) {
                        alert(`Error saving preference: ${error.message}`);
                        return;
                    }
                    alert('Preference saved successfully!');
                }
    
                // Reset form and reload preferences
                resetForm();
                loadPreferences();
            } catch (err) {
                alert(`Unexpected error: ${err.message}`);
            }
        });
    
        /**
         * Reset the form to its initial state.
         */
        function resetForm() {
            document.getElementById('pref_id').value = '';
            document.getElementById('location').value = '';
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
            document.getElementById('temp_min').value = '';
            document.getElementById('temp_max').value = '';
            document.getElementById('humidity_min').value = '';
            document.getElementById('humidity_max').value = '';
            isEditing = false;
            document.getElementById('save-button').textContent = "Save Preferences";
        }
    
        // Add event listeners for logout and home navigation
        document.getElementById('logout-button').addEventListener('click', () => {
            localStorage.removeItem('user_id');
            window.location.href = '/';
        });
    
        document.getElementById('home-button').addEventListener('click', () => {
            window.location.href = '/fetch_weather';
        });
    
        // Load preferences when the page loads
        document.addEventListener('DOMContentLoaded', loadPreferences);
    </script>
    
</body>
</html>
